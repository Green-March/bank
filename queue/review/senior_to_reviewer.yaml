plan_review_request:
  request_id: "plan_req_20260217_007_009"
  revision: 2
  objective: "req_20260217_007〜009（equity alias / metrics_series重複 / fiscal_year=None汚染）を正規フローで解消する"
  scope:
    ticker: "7685"
    requests:
      - "req_20260217_007"
      - "req_20260217_008"
      - "req_20260217_009"
    target_files:
      - "skills/financial-calculator/scripts/metrics.py"
      - "skills/financial-calculator/tests/test_cli_real_data.py"
    due_date: "2026-02-17"
  workplan:
    - id: "req_20260217_007_T1"
      owner: "junior1"
      action: "metrics.py の equity aliases に total_equity を追加し、ROE/自己資本比率の回帰テストを追加する"
      output: "skills/financial-calculator/scripts/metrics.py, skills/financial-calculator/tests/test_cli_real_data.py"
      depends_on: []
    - id: "req_20260217_008_T2"
      owner: "junior1"
      action: "重複解消ルールを固定仕様で実装する（同一 fiscal_year は代表1件のみ採用。優先順位: 1) 非null項目数が多いレコード 2) period_type優先 mixed>duration>instant 3) period_end が新しい）"
      output: "skills/financial-calculator/scripts/metrics.py, skills/financial-calculator/tests/test_cli_real_data.py"
      depends_on:
        - "req_20260217_007_T1"
    - id: "req_20260217_009_T3"
      owner: "junior1"
      action: "_extract_candidates のフォールバックを修正し fiscal_year=None 汚染を防止、重複ケースとNone混入ケースの期待値固定テストを追加、pytest を実行する"
      output: "skills/financial-calculator/scripts/metrics.py, skills/financial-calculator/tests/test_cli_real_data.py, logs/req_20260217_009_pytest.txt"
      depends_on:
        - "req_20260217_008_T2"
    - id: "req_20260217_009_T4"
      owner: "junior2"
      action: "独立QAとして data/7685/processed で calculate 結果を検証し、FY重複なし・fiscal_year=Noneなし・指標復旧を確認する。QAレポートにデータ版情報を記載する"
      output: "data/7685/qa/metrics_regression_req_20260217_007_009.md"
      depends_on:
        - "req_20260217_009_T3"
  quality_criteria:
    - "metrics.py の equity alias に total_equity が含まれる"
    - "metrics_series で fiscal_year 重複が発生しない"
    - "fiscal_year=None のエントリが metrics_series に混入しない"
    - "重複ケース・None混入ケースの期待値固定テストが追加される"
    - "pytest skills/financial-calculator/tests が全PASS（既存85件を下回らない）"
    - "QAレポートに data/7685/processed の版情報（financials.json の generated_at と record_count/source_count）を明記する"
  risk_controls:
    - "RACE-001対応: metrics.py の編集タスクは junior1 に限定し同時編集を禁止"
    - "junior2 は read/qa 専任とし、コード修正は行わない"
    - "review verdict が revise の場合は task_id 単位で修正点を再割当する"
